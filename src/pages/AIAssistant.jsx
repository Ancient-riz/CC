import React, { useState, useRef, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { ArrowLeft, Send, Bot, User, Lightbulb, BookOpen, Target, Users } from 'lucide-react';

const AIAssistant = () => {
  const [messages, setMessages] = useState([
    {
      id: 1,
      type: 'bot',
      content: "Hello! I'm your AI Career Counselor powered by advanced AI. I'm here to help you with career guidance, stream selection, exam preparation, and any questions about your future. How can I assist you today?",
      timestamp: new Date()
    }
  ]);
  const [inputMessage, setInputMessage] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const messagesEndRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const quickQuestions = [
    "Which stream should I choose after 10th?",
    "What are the best engineering entrance exams?",
    "How to become a doctor in India?",
    "Career options in Commerce stream",
    "Skills needed for software engineering",
    "Best colleges for MBA in India",
    "How to prepare for NEET?",
    "What is the scope of Data Science?",
    "Career opportunities in Arts stream",
    "How to get into IIT?"
  ];

  const handleSendMessage = async () => {
    if (!inputMessage.trim()) return;

    const userMessage = {
      id: messages.length + 1,
      type: 'user',
      content: inputMessage,
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMessage]);
    setInputMessage('');
    setIsTyping(true);

    try {
      // Try Gemini AI API first
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyAwq55eOhlaTI1tmcq1PoiTNFPsd4g2YmY`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            parts: [{
              text: `You are a career counselor AI assistant for Career Canvas platform in India. Answer this career-related question: ${inputMessage}. 

              Provide helpful, accurate, and encouraging guidance about careers, education, streams, exams, and skills specifically for Indian students. Include specific information about:
              - Indian education system (Class 10, 12, UG, PG)
              - Indian entrance exams (JEE, NEET, CAT, CLAT, etc.)
              - Indian colleges and universities
              - Career opportunities in India
              - Salary ranges in Indian context
              - Government job opportunities
              
              Keep responses concise but informative (200-300 words). Use bullet points for better readability. Be encouraging and supportive.`
            }]
          }]
        })
      });

      if (response.ok) {
        const data = await response.json();
        const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || generateFallbackResponse(inputMessage);
        
        const botMessage = {
          id: messages.length + 2,
          type: 'bot',
          content: aiResponse,
          timestamp: new Date()
        };
        
        setMessages(prev => [...prev, botMessage]);
      } else {
        throw new Error('Gemini API failed');
      }
    } catch (error) {
      console.error('Error calling Gemini API:', error);
      
      // Try OpenAI API as fallback
      try {
        const openAIResponse = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${process.env.OPENAI_API_KEY || 'your-openai-api-key'}`
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [
              {
                role: 'system',
                content: 'You are a career counselor AI assistant for Career Canvas platform in India. Provide helpful career guidance for Indian students.'
              },
              {
                role: 'user',
                content: inputMessage
              }
            ],
            max_tokens: 300,
            temperature: 0.7
          })
        });

        if (openAIResponse.ok) {
          const openAIData = await openAIResponse.json();
          const aiResponse = openAIData.choices?.[0]?.message?.content || generateFallbackResponse(inputMessage);
          
          const botMessage = {
            id: messages.length + 2,
            type: 'bot',
            content: aiResponse,
            timestamp: new Date()
          };
          
          setMessages(prev => [...prev, botMessage]);
        } else {
          throw new Error('OpenAI API failed');
        }
      } catch (openAIError) {
        console.error('Error calling OpenAI API:', openAIError);
        // Fallback to local responses
        const fallbackResponse = generateFallbackResponse(inputMessage);
        const botMessage = {
          id: messages.length + 2,
          type: 'bot',
          content: fallbackResponse,
          timestamp: new Date()
        };
        setMessages(prev => [...prev, botMessage]);
      }
    } finally {
      setIsTyping(false);
    }
  };

  const generateFallbackResponse = (userInput) => {
    const input = userInput.toLowerCase();
    
    if (input.includes('stream') || input.includes('10th') || input.includes('12th')) {
      return "**Stream Selection Guide** üéØ\n\nChoosing the right stream after Class 10 is crucial for your career:\n\n**Science Stream (PCM/PCB):**\n‚Ä¢ Engineering, Medical, Research careers\n‚Ä¢ High-demand technical fields\n‚Ä¢ Entrance exams: JEE, NEET, BITSAT\n\n**Commerce Stream:**\n‚Ä¢ Business, Finance, CA, MBA paths\n‚Ä¢ Entrepreneurship opportunities\n‚Ä¢ Exams: CA Foundation, CLAT, CUET\n\n**Arts/Humanities:**\n‚Ä¢ Civil Services, Law, Journalism, Psychology\n‚Ä¢ Creative and social impact careers\n‚Ä¢ Exams: CLAT, CUET, UPSC CSE\n\n**üí° Recommendation:** Take our aptitude test to get personalized stream suggestions based on your interests and strengths!\n\nWould you like specific guidance about any stream?";
    }
    
    if (input.includes('engineering') || input.includes('jee') || input.includes('iit')) {
      return "**Engineering Career Path** ‚öôÔ∏è\n\n**Key Entrance Exams:**\n‚Ä¢ **JEE Main** - NITs, IIITs, other engineering colleges\n‚Ä¢ **JEE Advanced** - IITs (top tier)\n‚Ä¢ **BITSAT** - BITS Pilani\n‚Ä¢ **State CETs** - State engineering colleges\n\n**Top Specializations:**\n‚Ä¢ Computer Science & Engineering (highest demand)\n‚Ä¢ Artificial Intelligence & Machine Learning\n‚Ä¢ Electronics & Communication\n‚Ä¢ Mechanical, Civil, Chemical Engineering\n\n**Preparation Strategy:**\n‚Ä¢ Strong foundation in Physics, Chemistry, Mathematics\n‚Ä¢ Start preparation in Class 11\n‚Ä¢ Regular practice with previous year papers\n‚Ä¢ Take mock tests consistently\n\n**Career Prospects:**\n‚Ä¢ Software Engineer: ‚Çπ3-25 LPA\n‚Ä¢ Core Engineering roles: ‚Çπ4-15 LPA\n‚Ä¢ Research & Development: ‚Çπ5-20 LPA\n‚Ä¢ Entrepreneurship opportunities\n\nNeed specific guidance on any engineering branch or exam preparation?";
    }
    
    if (input.includes('doctor') || input.includes('medical') || input.includes('mbbs') || input.includes('neet')) {
      return "**Medical Career Pathway** ü©∫\n\n**Education Journey:**\n‚Ä¢ **Class 12:** PCB (Physics, Chemistry, Biology)\n‚Ä¢ **NEET UG:** For MBBS/BDS admission\n‚Ä¢ **MBBS:** 5.5 years (4.5 years + 1 year internship)\n‚Ä¢ **NEET PG:** For MD/MS specialization (optional)\n\n**NEET Preparation Tips:**\n‚Ä¢ Focus heavily on NCERT textbooks\n‚Ä¢ Biology is scoring - don't neglect Physics & Chemistry\n‚Ä¢ Practice MCQs extensively\n‚Ä¢ Take regular mock tests\n‚Ä¢ Maintain consistency in studies\n\n**Career Options:**\n‚Ä¢ **General Practitioner:** ‚Çπ5-15 LPA\n‚Ä¢ **Specialist (after MD/MS):** ‚Çπ15-50+ LPA\n‚Ä¢ **Government Medical Officer:** ‚Çπ8-20 LPA\n‚Ä¢ **Private Practice:** Variable income\n‚Ä¢ **Medical Research:** ‚Çπ6-25 LPA\n\n**Alternative Medical Careers:**\n‚Ä¢ BAMS (Ayurveda), BHMS (Homeopathy)\n‚Ä¢ BDS (Dental), BPT (Physiotherapy)\n‚Ä¢ B.Pharm (Pharmacy), B.Sc Nursing\n\nWant specific guidance on NEET preparation or medical specializations?";
    }

    if (input.includes('commerce') || input.includes('ca') || input.includes('mba') || input.includes('business')) {
      return "**Commerce Stream Opportunities** üíº\n\n**Popular Career Paths:**\n\n**1. Chartered Accountancy (CA):**\n‚Ä¢ Duration: 3-5 years\n‚Ä¢ Salary: ‚Çπ6-30+ LPA\n‚Ä¢ High respect and job security\n\n**2. MBA/Management:**\n‚Ä¢ Entrance: CAT, XAT, CMAT\n‚Ä¢ Top IIMs offer ‚Çπ20-50+ LPA packages\n‚Ä¢ Specializations: Finance, Marketing, HR, Operations\n\n**3. Company Secretary (CS):**\n‚Ä¢ Corporate law and compliance expert\n‚Ä¢ Salary: ‚Çπ5-20 LPA\n\n**4. Banking & Finance:**\n‚Ä¢ Bank PO, Investment Banking\n‚Ä¢ Salary: ‚Çπ4-25 LPA\n\n**5. Entrepreneurship:**\n‚Ä¢ Start your own business\n‚Ä¢ Unlimited earning potential\n\n**Key Skills to Develop:**\n‚Ä¢ Financial literacy\n‚Ä¢ Communication skills\n‚Ä¢ Leadership abilities\n‚Ä¢ Analytical thinking\n\n**Entrance Exams:**\n‚Ä¢ CA Foundation, CAT, XAT, CLAT, CUET\n\nWhich commerce career interests you most?";
    }

    if (input.includes('arts') || input.includes('humanities') || input.includes('upsc') || input.includes('civil services')) {
      return "**Arts & Humanities Career Guide** üé®\n\n**High-Impact Career Options:**\n\n**1. Civil Services (UPSC):**\n‚Ä¢ IAS, IPS, IFS officers\n‚Ä¢ Salary: ‚Çπ5-15 LPA + benefits\n‚Ä¢ High social impact and prestige\n\n**2. Law & Legal Services:**\n‚Ä¢ Entrance: CLAT for 5-year LLB\n‚Ä¢ Corporate lawyers earn ‚Çπ8-50+ LPA\n‚Ä¢ Judicial services, legal consulting\n\n**3. Journalism & Media:**\n‚Ä¢ Print, digital, broadcast journalism\n‚Ä¢ Content creation, PR, advertising\n‚Ä¢ Salary: ‚Çπ3-20 LPA\n\n**4. Psychology & Social Work:**\n‚Ä¢ Clinical psychology, counseling\n‚Ä¢ NGO work, social development\n‚Ä¢ Salary: ‚Çπ3-15 LPA\n\n**5. Teaching & Academia:**\n‚Ä¢ School teaching, university professor\n‚Ä¢ Research and academic writing\n‚Ä¢ Salary: ‚Çπ3-20 LPA\n\n**Key Advantages:**\n‚Ä¢ Develop critical thinking\n‚Ä¢ Strong communication skills\n‚Ä¢ Social awareness and empathy\n‚Ä¢ Diverse career opportunities\n\n**Entrance Exams:**\n‚Ä¢ CUET, CLAT, JNU entrance, BHU UET\n\nWhich arts career path interests you?";
    }

    if (input.includes('data science') || input.includes('ai') || input.includes('machine learning')) {
      return "**Data Science & AI Career Guide** ü§ñ\n\n**Why Data Science is Hot:**\n‚Ä¢ Fastest growing field globally\n‚Ä¢ High demand across all industries\n‚Ä¢ Excellent salary packages\n‚Ä¢ Future-proof career\n\n**Educational Path:**\n‚Ä¢ **UG:** B.Sc Data Science, B.Tech CSE, B.Sc Statistics\n‚Ä¢ **PG:** M.Sc Data Science, M.Tech AI/ML\n‚Ä¢ **Certifications:** Google, IBM, Microsoft AI courses\n\n**Key Skills Required:**\n‚Ä¢ Programming: Python, R, SQL\n‚Ä¢ Statistics and Mathematics\n‚Ä¢ Machine Learning algorithms\n‚Ä¢ Data visualization tools\n‚Ä¢ Business understanding\n\n**Career Roles & Salaries:**\n‚Ä¢ **Data Analyst:** ‚Çπ3-8 LPA\n‚Ä¢ **Data Scientist:** ‚Çπ6-25 LPA\n‚Ä¢ **ML Engineer:** ‚Çπ8-30 LPA\n‚Ä¢ **AI Research Scientist:** ‚Çπ15-50+ LPA\n\n**Top Hiring Companies:**\n‚Ä¢ Google, Microsoft, Amazon\n‚Ä¢ Flipkart, Zomato, Ola\n‚Ä¢ Banks, consulting firms\n‚Ä¢ Healthcare, fintech startups\n\n**Learning Resources:**\n‚Ä¢ Coursera, edX online courses\n‚Ä¢ Kaggle competitions\n‚Ä¢ GitHub projects\n\nWant specific guidance on getting started in Data Science?";
    }

    if (input.includes('salary') || input.includes('package') || input.includes('earning')) {
      return "**Career Salary Guide in India** üí∞\n\n**Engineering (Fresh Graduates):**\n‚Ä¢ Software Engineer: ‚Çπ3-12 LPA\n‚Ä¢ Core Engineering: ‚Çπ3-8 LPA\n‚Ä¢ Top IIT graduates: ‚Çπ15-50+ LPA\n\n**Medical Field:**\n‚Ä¢ MBBS Doctor: ‚Çπ5-15 LPA\n‚Ä¢ Specialist (MD/MS): ‚Çπ15-50+ LPA\n‚Ä¢ Government Medical Officer: ‚Çπ8-20 LPA\n\n**Commerce & Management:**\n‚Ä¢ CA (Fresher): ‚Çπ6-12 LPA\n‚Ä¢ MBA from top B-schools: ‚Çπ15-50+ LPA\n‚Ä¢ Banking (PO level): ‚Çπ7-15 LPA\n\n**Arts & Humanities:**\n‚Ä¢ Civil Services (IAS/IPS): ‚Çπ5-15 LPA + benefits\n‚Ä¢ Lawyer: ‚Çπ3-50+ LPA (varies widely)\n‚Ä¢ Journalist: ‚Çπ3-15 LPA\n\n**Emerging Fields:**\n‚Ä¢ Data Science: ‚Çπ6-25 LPA\n‚Ä¢ Digital Marketing: ‚Çπ3-15 LPA\n‚Ä¢ UX/UI Design: ‚Çπ4-20 LPA\n\n**üí° Remember:**\n‚Ä¢ Salaries vary by city, company, experience\n‚Ä¢ Skills and performance matter more than degree\n‚Ä¢ Continuous learning increases earning potential\n\nWhich field's salary prospects interest you most?";
    }
    
    // Default response
    return "**I'm here to help with your career questions!** üéØ\n\nI can assist you with:\n\n**üìö Academic Guidance:**\n‚Ä¢ Stream selection after Class 10/12\n‚Ä¢ Course recommendations\n‚Ä¢ College and university information\n\n**üéØ Career Planning:**\n‚Ä¢ Career options by field\n‚Ä¢ Salary expectations\n‚Ä¢ Skills development\n\n**üìù Exam Preparation:**\n‚Ä¢ Entrance exam information\n‚Ä¢ Preparation strategies\n‚Ä¢ Important dates and deadlines\n\n**üèõÔ∏è Institution Guidance:**\n‚Ä¢ Top colleges and universities\n‚Ä¢ Admission processes\n‚Ä¢ Scholarship opportunities\n\n**üíº Professional Development:**\n‚Ä¢ Industry insights\n‚Ä¢ Job market trends\n‚Ä¢ Skill requirements\n\nTry asking specific questions like:\n‚Ä¢ \"What should I study to become a software engineer?\"\n‚Ä¢ \"How do I prepare for NEET?\"\n‚Ä¢ \"What are the career options in Commerce?\"\n‚Ä¢ \"Which colleges are best for MBA?\"\n\nWhat specific career guidance can I provide for you today?";
  };

  const handleQuickQuestion = (question) => {
    setInputMessage(question);
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
      {/* Header */}
      <header className="bg-slate-800/50 backdrop-blur-lg border-b border-purple-500/20">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center h-16">
            <Link
              to="/dashboard"
              className="flex items-center text-purple-400 hover:text-purple-300 mr-6 transition-colors"
            >
              <ArrowLeft className="w-4 h-4 mr-2" />
              Back to Dashboard
            </Link>
            <h1 className="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">
              Career Canvas
            </h1>
          </div>
        </div>
      </header>

      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Page Header */}
        <div className="text-center mb-8">
          <div className="flex items-center justify-center mb-4">
            <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
              <Bot className="w-8 h-8 text-white" />
            </div>
          </div>
          <h2 className="text-3xl font-bold text-white mb-2">
            AI Career Assistant
          </h2>
          <p className="text-lg text-gray-300">
            Get instant answers powered by advanced AI for your career questions
          </p>
        </div>

        {/* Chat Container */}
        <div className="bg-slate-800/50 backdrop-blur-lg rounded-lg border border-purple-500/20 overflow-hidden">
          {/* Messages Area */}
          <div className="h-96 overflow-y-auto p-6 space-y-4">
            {messages.map((message) => (
              <div
                key={message.id}
                className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}
              >
                <div className={`flex max-w-xs lg:max-w-md ${message.type === 'user' ? 'flex-row-reverse' : 'flex-row'}`}>
                  {/* Avatar */}
                  <div className={`flex-shrink-0 ${message.type === 'user' ? 'ml-3' : 'mr-3'}`}>
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                      message.type === 'user' 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-gradient-to-br from-purple-500 to-blue-600 text-white'
                    }`}>
                      {message.type === 'user' ? <User className="w-4 h-4" /> : <Bot className="w-4 h-4" />}
                    </div>
                  </div>
                  
                  {/* Message Bubble */}
                  <div className={`px-4 py-2 rounded-lg ${
                    message.type === 'user'
                      ? 'bg-blue-600 text-white'
                      : 'bg-slate-700/50 text-gray-100'
                  }`}>
                    <div className="text-sm whitespace-pre-line">{message.content}</div>
                    <div className={`text-xs mt-1 ${
                      message.type === 'user' ? 'text-blue-100' : 'text-gray-400'
                    }`}>
                      {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                    </div>
                  </div>
                </div>
              </div>
            ))}
            
            {/* Typing Indicator */}
            {isTyping && (
              <div className="flex justify-start">
                <div className="flex mr-3">
                  <div className="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-600 flex items-center justify-center text-white">
                    <Bot className="w-4 h-4" />
                  </div>
                </div>
                <div className="bg-slate-700/50 px-4 py-2 rounded-lg">
                  <div className="flex space-x-1">
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                  </div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          {/* Quick Questions */}
          <div className="border-t border-purple-500/20 p-4">
            <div className="mb-3">
              <h4 className="text-sm font-medium text-gray-300 mb-2">Quick Questions:</h4>
              <div className="flex flex-wrap gap-2">
                {quickQuestions.slice(0, 4).map((question, index) => (
                  <button
                    key={index}
                    onClick={() => handleQuickQuestion(question)}
                    className="px-3 py-1 text-xs bg-purple-500/20 text-purple-300 rounded-full hover:bg-purple-500/30 transition-colors"
                  >
                    {question}
                  </button>
                ))}
              </div>
            </div>
          </div>

          {/* Input Area */}
          <div className="border-t border-purple-500/20 p-4">
            <div className="flex space-x-3">
              <div className="flex-1">
                <textarea
                  value={inputMessage}
                  onChange={(e) => setInputMessage(e.target.value)}
                  onKeyPress={handleKeyPress}
                  placeholder="Ask me anything about careers, streams, exams, or colleges..."
                  className="w-full px-3 py-2 bg-slate-700/50 border border-purple-500/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                  rows="2"
                />
              </div>
              <button
                onClick={handleSendMessage}
                disabled={!inputMessage.trim() || isTyping}
                className="px-4 py-2 bg-gradient-to-r from-purple-600 to-cyan-600 text-white rounded-lg hover:from-purple-500 hover:to-cyan-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300"
              >
                <Send className="w-4 h-4" />
              </button>
            </div>
          </div>
        </div>

        {/* Quick Actions */}
        <div className="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
          <Link
            to="/aptitude-test"
            className="flex items-center p-4 bg-slate-800/50 backdrop-blur-lg rounded-lg border border-purple-500/20 hover:border-purple-400/40 transition-all duration-300"
          >
            <div className="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center mr-3">
              <Lightbulb className="w-5 h-5 text-green-400" />
            </div>
            <div>
              <div className="font-medium text-white">Take Aptitude Test</div>
              <div className="text-sm text-gray-400">Discover your strengths</div>
            </div>
          </Link>
          
          <Link
            to="/roadmap"
            className="flex items-center p-4 bg-slate-800/50 backdrop-blur-lg rounded-lg border border-purple-500/20 hover:border-purple-400/40 transition-all duration-300"
          >
            <div className="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center mr-3">
              <Target className="w-5 h-5 text-blue-400" />
            </div>
            <div>
              <div className="font-medium text-white">Create Roadmap</div>
              <div className="text-sm text-gray-400">Plan your career path</div>
            </div>
          </Link>
          
          <Link
            to="/institutions"
            className="flex items-center p-4 bg-slate-800/50 backdrop-blur-lg rounded-lg border border-purple-500/20 hover:border-purple-400/40 transition-all duration-300"
          >
            <div className="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center mr-3">
              <BookOpen className="w-5 h-5 text-purple-400" />
            </div>
            <div>
              <div className="font-medium text-white">Find Colleges</div>
              <div className="text-sm text-gray-400">Explore institutions</div>
            </div>
          </Link>
        </div>
      </div>
    </div>
  );
};

export default AIAssistant;